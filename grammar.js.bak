const PREC = {
  COMMENT: 20,
  HEADING: 10,
  HEADING_NEWLINE: 10,
  STRONG: 5,
}
const ALPHANUM_CHARS = "[a-zA-Z0-9]";
const NON_ALPHANUM_CHARS = "[^a-zA-Z0-9]";
const NON_ALPHANUM_CHARS_NO_STAR = "[^a-zA-Z0-9\*]";
// const NEWLINE = "\\n|\\r\\n"
const NEWLINE = "\\n";

module.exports = grammar({
  name: 'typst',

  extras: $ => [
    $.comment,
    $.line_comment,
    // $.block_comment
  ],

  // externals: $ => [
  //   $._strong_delim_opn,
  //   $._strong_delim_cls,
  // ],

  rules: {
    // content
    markup_block: $ => repeat(choice(
      $.heading,
      $.paragraph, 
      // $.strong,
    )),

    // heading
    // paragraph
    // code
    
    // line: $ => $._line_content,
    paragraph: $ => seq(
      $._line_content,
      $._parbreak
    ),

    _newline: $ => /\n/, // TODO: use NEWLINE
    _parbreak: $ => /\n\n/, // TODO: use NEWLINE

    // Headings
    heading: $ => seq(
      $._heading_prefix,
      alias($._line_content, $.heading_text),
      prec(PREC.HEADING_NEWLINE, $._newline),
    ),
    _heading_prefix: $ => token(prec(PREC.HEADING, /=+[ |\t]+/)), // at least one tab or space needed to be recognized as heading TODO: Capture group for ===?

    // Markup
    _line_content: $ => repeat1(choice(
      $.word,
      seq($.non_word_char_no_star, optional($.strong))
    )),

    _line_content_strong: $ => repeat1(choice(
      $.word_incl_star,
      $.non_word_char_no_star,
    )),

    word_incl_star: $ => new RegExp(`\\w(\\w|(\\w\*\\w))*\\w`),
    non_word_char_no_star: $ => new RegExp(`[^\\w\\*]`),

    // _line_content_in_strong: $ => optional(seq(
    //   choice($.text_alphanum, $.text_non_alphanum_no_star),
    //   
    // )),


    word: $ => new RegExp(`\w+`),
    // non_word_char: $ => RegExp(`\W`),
    // text_non_alphanum: $ => new RegExp(`${NON_ALPHANUM_CHARS}+`),
    // text_non_alphanum_no_star: $ => new RegExp(`${NON_ALPHANUM_CHARS_NO_STAR}+`),

    // text_emph: $ => choice(
    //   $.strong,
    // ),

    strong: $ => seq(
      prec(PREC.STRONG, "*"),
      optional($._line_content_strong),
      $._strong_delim_cls,
    ),
    // _strong_delim_opn: $ => token(prec(PREC.STRONG, new RegExp(`${NON_ALPHANUM_CHARS}\\\*`))),
    _strong_delim_cls: $ => prec(PREC.STRONG, new RegExp(`\\\*${NON_ALPHANUM_CHARS}`)),

    // Comments
    comment: $ => choice(
      $.line_comment,
      // $.block_comment,
    ),

    line_comment: $ => token(prec(PREC.COMMENT, new RegExp(`//[^${NEWLINE}]*${NEWLINE}`))),
    // block_comment: $ => seq(
    //   "/*", 
    //   // /[.*\n]*.*/,
    //   /[^*]*\*+([^/*][^*]*\*+)*/, // TODO, taken from java grammar
    //   //"*/", 
    //   "/", 
    // ),
  }
});

